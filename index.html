<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales MIS Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* CSS directly from IndexHTML_Modification060126.docx */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0; min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { margin-bottom: 30px; }
        h1 { font-size: 2.5rem; font-weight: 700; color: #fff; margin-bottom: 10px; }
        .subtitle { color: #94a3b8; font-size: 1.1rem; }
        .designer { color: #3b82f6; font-size: 1rem; font-weight: 700; margin-top: 5px; }
        
        /* Dashboard Layout */
        .filters {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px; background: #1e293b; padding: 25px; border-radius: 12px;
        }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.9rem; color: #cbd5e1; margin-bottom: 8px; }
        select, .multi-select-display {
            padding: 10px; background: #0f172a; border: 2px solid #334155;
            border-radius: 8px; color: #e2e8f0; cursor: pointer;
        }
        
        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 25px; border-radius: 12px; }
        .kpi-card.purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .kpi-card.pink { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); }
        .kpi-value { font-size: 2rem; font-weight: 700; }

        /* Tables and Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; }
        .chart-card { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .quarter-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .quarter-table th, .quarter-table td { padding: 12px; border: 1px solid #334155; text-align: center; }
        .growth-badge { padding: 4px 8px; border-radius: 12px; font-weight: bold; }
        .growth-positive { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .growth-negative { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        /* Chrome Fix: Manual Load UI */
        #manualLoad { background: #1e293b; padding: 40px; border-radius: 12px; text-align: center; display: none; }
        .btn-primary { background: #3b82f6; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š TVM-SALES Dashboard</h1>
            <p class="subtitle">Sales Analytics and Insights</p>
            <p class="designer">Designed by Prasad K</p>
        </header>

        <div id="manualLoad">
            <h2>Chrome Security Check</h2>
            <p style="margin: 15px 0;">To view data on Chrome, please select your <b>SALESMIS.csv</b> file below:</p>
            <input type="file" id="fileInput" accept=".csv" style="margin-bottom: 20px;"><br>
            <button class="btn-primary" onclick="handleManualFile()">Launch Dashboard</button>
        </div>

        <div id="dashboard">
            <div class="filters">
                <div class="filter-group">
                    <label>Branch</label>
                    <select id="branchFilter" onchange="updateDashboard()"><option value="All">All Branches</option></select>
                </div>
                <div class="filter-group">
                    <label>Customer Type</label>
                    <select id="typeFilter" onchange="updateDashboard()"><option value="All">All Types</option></select>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-label">Total Revenue</div><div id="totalRev" class="kpi-value">â‚¹0</div></div>
                <div class="kpi-card purple"><div class="kpi-label">Total Customers</div><div id="totalCust" class="kpi-value">0</div></div>
                <div class="kpi-card pink"><div class="kpi-label">Avg Revenue/Customer</div><div id="avgRev" class="kpi-value">â‚¹0</div></div>
            </div>

            <div class="chart-card">
                <h3>Monthly Revenue Trend</h3>
                <canvas id="revChart" height="100"></canvas>
            </div>

            <div class="chart-card">
                <h3>Quarterly Performance (Lakhs)</h3>
                <table class="quarter-table">
                    <thead>
                        <tr>
                            <th>Branch</th><th>Q1 (Apr-Jun)</th><th>Q2 (Jul-Sep)</th><th>Growth %</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let chart = null;
        const MONTHS = ['Apr-25', 'May-25', 'Jun-25', 'Jul-25', 'Aug-25', 'Sep-25', 'Oct-25', 'Nov-25'];

        // Try to auto-load (Works in Firefox or Local Server)
        async function init() {
            try {
                const response = await fetch('SALESMIS.csv');
                if (!response.ok) throw new Error();
                const text = await response.text();
                processCSV(text);
            } catch (e) {
                // If Chrome blocks fetch, show manual load button
                document.getElementById('manualLoad').style.display = 'block';
                document.getElementById('dashboard').style.opacity = '0.3';
            }
        }

        function handleManualFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("Please select SALESMIS.csv");
            const reader = new FileReader();
            reader.onload = (e) => processCSV(e.target.result);
            reader.readAsText(file);
        }

        function processCSV(csvText) {
            Papa.parse(csvText, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    rawData = results.data.filter(r => r.Branch && !r.Branch.includes('TOTAL'));
                    document.getElementById('manualLoad').style.display = 'none';
                    document.getElementById('dashboard').style.opacity = '1';
                    setupFilters();
                    updateDashboard();
                }
            });
        }

        function setupFilters() {
            const branches = [...new Set(rawData.map(r => r.Branch))].sort();
            const types = [...new Set(rawData.map(r => r.Customer_Type))].sort();
            const bFilter = document.getElementById('branchFilter');
            const tFilter = document.getElementById('typeFilter');
            
            branches.forEach(b => bFilter.add(new Option(b, b)));
            types.forEach(t => tFilter.add(new Option(t, t)));
        }

        function updateDashboard() {
            const branch = document.getElementById('branchFilter').value;
            const type = document.getElementById('typeFilter').value;
            
            const filtered = rawData.filter(r => 
                (branch === 'All' || r.Branch === branch) && 
                (type === 'All' || r.Customer_Type === type)
            );

            let total = 0;
            const monthlySums = MONTHS.map(m => {
                const sum = filtered.reduce((acc, row) => acc + (parseFloat(String(row[m] || '0').replace(/,/g, '')) || 0), 0);
                total += sum;
                return sum;
            });

            document.getElementById('totalRev').innerText = 'â‚¹' + (total / 10000000).toFixed(2) + ' Cr';
            document.getElementById('totalCust').innerText = new Set(filtered.map(r => r.Party_no)).size;
            
            renderChart(monthlySums);
            renderTable(filtered);
        }

        function renderChart(data) {
            const ctx = document.getElementById('revChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: MONTHS,
                    datasets: [{ label: 'Revenue', data: data, borderColor: '#3b82f6', tension: 0.3, fill: true, backgroundColor: 'rgba(59,130,246,0.1)' }]
                },
                options: { responsive: true }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const branches = [...new Set(data.map(r => r.Branch))];
            
            branches.forEach(b => {
                const rows = data.filter(r => r.Branch === b);
                const q1 = rows.reduce((s, r) => s + (parseFloat(String(r['Apr-25']||0).replace(/,/g,'')) + parseFloat(String(r['May-25']||0).replace(/,/g,'')) + parseFloat(String(r['Jun-25']||0).replace(/,/g,''))), 0);
                const q2 = rows.reduce((s, r) => s + (parseFloat(String(r['Jul-25']||0).replace(/,/g,'')) + parseFloat(String(r['Aug-25']||0).replace(/,/g,'')) + parseFloat(String(r['Sep-25']||0).replace(/,/g,''))), 0);
                const growth = q1 > 0 ? ((q2 - q1) / q1 * 100).toFixed(1) : 0;

                tbody.innerHTML += `<tr>
                    <td>${b}</td>
                    <td>${(q1/100000).toFixed(1)} L</td>
                    <td>${(q2/100000).toFixed(1)} L</td>
                    <td><span class="growth-badge ${growth >= 0 ? 'growth-positive' : 'growth-negative'}">${growth}%</span></td>
                </tr>`;
            });
        }

        window.onload = init;
    </script>
</body>
</html>
