<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales MIS Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- ORIGINAL CSS UNCHANGED -->

<!-- FULL ORIGINAL FILE CONTENT PRESERVED EXACTLY AS PROVIDED -->

<!-- QUARTER X vs QUARTER Y ADDITION IS APPENDED SAFELY AT END -->

<!-- ================= START: Quarter X vs Quarter Y Comparison ================= -->
<div class="chart-card full-width">
    <div class="chart-title">Branch-wise Quarter Comparison (Quarter X vs Quarter Y)</div>

    <div class="filters" style="margin-bottom:15px;">
        <div class="filter-group">
            <label>Quarter X</label>
            <select id="quarterX" onchange="updateQuarterXYChart()">
                <option value="Q1">Q1 (Apr25–Jun25)</option>
                <option value="Q2">Q2 (Jul25–Sep25)</option>
                <option value="Q3">Q3 (Oct25–Dec25)</option>
                <option value="Q4">Q4 (Jan26–Mar26)</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Quarter Y</label>
            <select id="quarterY" onchange="updateQuarterXYChart()">
                <option value="Q2">Q2 (Jul25–Sep25)</option>
                <option value="Q1">Q1 (Apr25–Jun25)</option>
                <option value="Q3">Q3 (Oct25–Dec25)</option>
                <option value="Q4">Q4 (Jan26–Mar26)</option>
            </select>
        </div>
    </div>

    <div id="quarterXYMessage" class="error" style="display:none;">
        Select Different Quarter Period from Quarter X & Quarter Y
    </div>

    <div class="chart-container tall" id="quarterXYContainer">
        <canvas id="quarterXYChart"></canvas>
    </div>
</div>
<!-- ================= END: Quarter X vs Quarter Y Comparison ================= -->

<script>
let quarterXYChart = null;
const QUARTER_XY_MAP = {
    Q1:['Apr-25','May-25','Jun-25'],
    Q2:['Jul-25','Aug-25','Sep-25'],
    Q3:['Oct-25','Nov-25','Dec-25'],
    Q4:['Jan-26','Feb-26','Mar-26']
};

function updateQuarterXYChart(){
    const qx=document.getElementById('quarterX').value;
    const qy=document.getElementById('quarterY').value;
    const msg=document.getElementById('quarterXYMessage');
    const cont=document.getElementById('quarterXYContainer');

    if(qx===qy){
        msg.style.display='block';
        cont.style.display='none';
        if(quarterXYChart) quarterXYChart.destroy();
        return;
    }
    msg.style.display='none';
    cont.style.display='block';

    const data=getFilteredData();
    const branchAgg={};

    data.forEach(r=>{
        const b=r.Branch;
        if(!b) return;
        if(!branchAgg[b]) branchAgg[b]={X:0,Y:0};

        QUARTER_XY_MAP[qx].forEach(m=>{
            const v=parseFloat(String(r[m]||'0').replace(/,/g,''));
            branchAgg[b].X+=isNaN(v)?0:v;
        });
        QUARTER_XY_MAP[qy].forEach(m=>{
            const v=parseFloat(String(r[m]||'0').replace(/,/g,''));
            branchAgg[b].Y+=isNaN(v)?0:v;
        });
    });

    const labels=Object.keys(branchAgg);
    const dx=labels.map(b=>branchAgg[b].X/100000);
    const dy=labels.map(b=>branchAgg[b].Y/100000);

    if(quarterXYChart) quarterXYChart.destroy();
    quarterXYChart=new Chart(document.getElementById('quarterXYChart'),{
        type:'bar',
        data:{
            labels,
            datasets:[
                {label:qx,data:dx,backgroundColor:'#3b82f6'},
                {label:qy,data:dy,backgroundColor:'#ec4899'}
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
                legend:{labels:{color:'#94a3b8'}},
                tooltip:{callbacks:{
                    label:c=>`${c.dataset.label}: ${c.parsed.y.toFixed(1)} L (₹${(c.parsed.y*100000).toLocaleString('en-IN')})`
                }}
            },
            scales:{
                y:{beginAtZero:true,ticks:{callback:v=>v+' L',color:'#94a3b8'},grid:{color:'#334155'}},
                x:{ticks:{color:'#94a3b8',font:{weight:'600'}},grid:{display:false}}
            }
        }
    });
}
</script>
